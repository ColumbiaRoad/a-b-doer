"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _exportNames={bundler:true};exports.bundler=bundler;var _path=_interopRequireDefault(require("path"));var _fs=_interopRequireDefault(require("fs"));var _rollup=require("rollup");var _pluginNodeResolve=_interopRequireDefault(require("@rollup/plugin-node-resolve"));var _pluginBabel=_interopRequireDefault(require("@rollup/plugin-babel"));var _rollupPluginTerser=require("rollup-plugin-terser");var _rollupPluginStyles=_interopRequireDefault(require("rollup-plugin-styles"));var _stringHash=_interopRequireDefault(require("string-hash"));var _autoprefixer=_interopRequireDefault(require("autoprefixer"));var _pluginAlias=_interopRequireDefault(require("@rollup/plugin-alias"));var _pluginReplace=_interopRequireDefault(require("@rollup/plugin-replace"));var _pluginCommonjs=_interopRequireDefault(require("@rollup/plugin-commonjs"));var _puppeteer=require("./puppeteer");Object.keys(_puppeteer).forEach(function(key){if(key==="default"||key==="__esModule")return;if(Object.prototype.hasOwnProperty.call(_exportNames,key))return;if(key in exports&&exports[key]===_puppeteer[key])return;Object.defineProperty(exports,key,{enumerable:true,get:function(){return _puppeteer[key]}})});var _rollupPluginInlineSvg=_interopRequireDefault(require("rollup-plugin-inline-svg"));var _rollupPluginSvgHyperscript=_interopRequireDefault(require("rollup-plugin-svg-hyperscript"));var _pluginImage=_interopRequireDefault(require("@rollup/plugin-image"));var _rollupChunkImage=_interopRequireDefault(require("./plugins/rollup-chunk-image"));var _browserslist=_interopRequireDefault(require("browserslist"));var _utils=require("./utils");var _chalk=_interopRequireDefault(require("chalk"));var _rimraf=_interopRequireDefault(require("rimraf"));var _glob=require("glob");var _preactDebugPlugin=require("./preact-debug-plugin");var _rollupPluginTypescript=_interopRequireDefault(require("rollup-plugin-typescript2"));var _rollupPluginIife=_interopRequireDefault(require("rollup-plugin-iife"));var _terser=require("terser");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const browsers=(0,_browserslist.default)();const supportIE=!!browsers.find(b=>b.startsWith("ie"));const rootDir=_path.default.join(__dirname,"..","..");async function bundler(testConfig){let{entryFile,testPath,entry,entryPart,preview=false}=testConfig;if(!entryFile&&entry){entryFile=entry;if(entry.startsWith(".")){entryFile=_path.default.join(testPath,entry)}}if(!entryPart&&entry){entryPart=entry}if(!entryFile||!testPath){throw new Error("Entry file or test path is missing")}const buildDir=_path.default.join(testPath,testConfig.buildDir);testConfig.buildDir=buildDir;try{if(!_fs.default.existsSync(buildDir)){_fs.default.mkdirSync(buildDir)}}catch(error){}const{minify:configMinify,preact,modules,id,chunks,chunkImages,watch,bundler:bundlerConfig={}}=testConfig;const minify=configMinify??!watch;const babelConfig={babelrc:false,presets:[["@babel/preset-typescript",{modules:false}]],plugins:["transform-async-to-promises","@babel/plugin-proposal-class-properties","@babel/plugin-proposal-optional-chaining","@babel/plugin-proposal-nullish-coalescing-operator",["@babel/plugin-transform-react-jsx",{pragma:"h",pragmaFrag:preact?"Fragment":"hf",throwIfNamespace:false}],["@emotion/babel-plugin-jsx-pragmatic",preact?{module:"preact",import:"h, Fragment",export:"h, Fragment"}:{module:_path.default.join(rootDir,"/src/jsx"),import:"h, hf",export:"h, hf"}]].filter(Boolean),exclude:/core-js/,extensions:[".js",".jsx",".ts",".tsx"]};let stylesOnly=/\.(le|sa|sc|c)ss$/.test(entryFile);if(!entryFile){throw new Error("Couldn't find entry file")}const useSourcemaps=watch&&testConfig.sourcemap!==false;const cwd=process.cwd();const{plugins=[],input:_i,watch:_w,output={},...restBundlerConfig}=bundlerConfig;const PREACT=(0,_utils.getFlagEnv)("PREACT")??!!preact;const NODE_ENV=JSON.stringify("production");const IE=(0,_utils.getFlagEnv)("IE")??supportIE;const PREVIEW=Boolean(watch||preview);const TEST_ENV=(0,_utils.getFlagEnv)("TEST_ENV")||false;const TEST_ID=id||"t"+((0,_utils.hashf)(_path.default.dirname((0,_utils.unifyPath)(testPath))).toString(36)||"-default");process.env.PREACT=process.env.preact=PREACT;process.env.NODE_ENV=NODE_ENV;process.env.IE=IE;process.env.PREVIEW=PREVIEW;process.env.TEST_ENV=TEST_ENV;process.env.TEST_ID=TEST_ID;const chunksInputConfig=chunks?{preserveEntrySignatures:"allow-extension",inlineDynamicImports:false}:{};const inputOptions={input:[entryFile],treeshake:"smallest",plugins:getPluginsConfig([["preact-debug"],["alias",{entries:[{find:/^@\/(.*)/,replacement:_path.default.join(cwd,"$1")},{find:"react",replacement:"preact/compat"},{find:"react-dom",replacement:"preact/compat"}]}],["typescript",useSourcemaps?{tsconfigOverride:{compilerOptions:{sourceMap:true,inlineSourceMap:true}}}:{}],["node-resolve",{extensions:babelConfig.extensions,moduleDirectories:["node_modules",_path.default.join(rootDir,"node_modules")]}],["babel",{...babelConfig,babelHelpers:"bundled"}],["commonjs",{transformMixedEsModules:true}],["styles",{mode:"extract",minimize:minify,modules:modules!==false?{generateScopedName:minify?(name,file)=>{return"t"+(0,_stringHash.default)((0,_utils.unifyPath)(file)).toString(36).substr(0,4)+"-"+name}:"t_[dir]_[name]_[local]__[hash:4]"}:undefined,plugins:[_autoprefixer.default],url:{inline:true},alias:{scss:_path.default.join(cwd,"/scss"),sass:_path.default.join(cwd,"/sass"),less:_path.default.join(cwd,"/less"),styles:_path.default.join(cwd,"/styles"),css:_path.default.join(cwd,"css"),"@":cwd}}],["replace",{preventAssignment:true,values:{"process.env.PREACT":PREACT,"process.env.preact":PREACT,"process.env.NODE_ENV":NODE_ENV,"process.env.IE":IE,"process.env.PREVIEW":PREVIEW,"process.env.TEST_ENV":TEST_ENV,"process.env.TEST_ID":JSON.stringify(TEST_ID)}}],["image",{exclude:["**/*.svg"]}],(0,_rollupChunkImage.default)(chunkImages),preact?["svg-hyperscript",{importDeclaration:"import {h} from \"preact\"",pragma:"h",transformPropNames:false}]:["inline-svg",{removeSVGTagAttrs:false}],chunks&&["iife"]].filter(Boolean),[...plugins]),watch:false,...chunksInputConfig,...restBundlerConfig};const sourceMapOptions=useSourcemaps?{sourcemap:"inline",sourcemapPathTransform:(relativeSourcePath,sourcemapPath)=>{return"file:///"+_path.default.resolve(_path.default.dirname(sourcemapPath),relativeSourcePath)}}:{};const chunksOuputConfig=chunks?{format:"amd",amd:{autoId:true}}:{};const outputOptions={dir:buildDir,assetFileNames:"[name].css",strict:false,format:"iife",exports:"named",name:_path.default.basename(entryFile).split(".")[0],intro:minify?"const window = self; const document = window.document;":"",plugins:[minify&&(0,_rollupPluginTerser.terser)(Object.assign({mangle:{toplevel:true},format:{comments:false}},chunkImages&&{compress:{evaluate:false}}))].filter(Boolean),...chunksOuputConfig,...sourceMapOptions,...output};let bundle;let bundleOutput={output:[]};if(outputOptions.entryFileNames&&!output.assetFileNames){outputOptions.assetFileNames=getFileAs(outputOptions.entryFileNames,"css")}const clearHashedAssets=()=>{if(/\[hash(]|:)/.test(outputOptions.entryFileNames)||chunks){const files=_glob.glob.sync("**/*.?(js|css|map)",{cwd:buildDir,dot:true});files.forEach(file=>{(0,_rimraf.default)(`${buildDir}/${file}`,err=>{if(err)console.error(err)})})}};const fnIifeCheck=/^(\(|function)/;const createAssetBundle=async()=>{let mainChunk=bundleOutput.output[0];let cssChunks=bundleOutput.output.filter(c=>c.fileName.endsWith(".css"));let js=mainChunk===null||mainChunk===void 0?void 0:mainChunk.code;let styles=cssChunks.reduce((acc,cur)=>acc+cur.source,"");if(stylesOnly){_fs.default.unlink(_path.default.resolve(buildDir,mainChunk.fileName),err=>{})}const outputChunks=[...bundleOutput.output];let amd;if(chunks){var _modules$facadeModule;const amdLoader=_fs.default.readFileSync(_path.default.resolve(__dirname,"amd.js")).toString();amd=await(0,_terser.minify)({"amd.js":amdLoader},{sourceMap:useSourcemaps&&{includeSources:true,asObject:true}});const{code,fileName,facadeModuleId,modules}=mainChunk;if(!watch){_fs.default.writeFile(_path.default.resolve(buildDir,fileName),`!(function(){${amd.code}\n${code}})();`,err=>{err&&console.error(err)})}outputChunks.unshift(amd);const mainModuleId=fileName.substr(0,fileName.lastIndexOf("."));const exps=((_modules$facadeModule=modules[facadeModuleId])===null||_modules$facadeModule===void 0?void 0:_modules$facadeModule.renderedExports)||[];if(!exps.length){console.warn(_chalk.default.yellow("File ",facadeModuleId,"has no exported functions. Chunk initialization will fail."));process.exit()}const exportIndex=Math.max(exps.indexOf("default"),0);outputChunks.push({code:`require(['${mainModuleId}'],function(m){m.${exps[exportIndex]}()});`})}const bundleMap={version:3,file:getFileAs(mainChunk.fileName,"bundle.js"),sections:[]};let assetBundle=outputChunks.filter(c=>!!c.code).reduce((bundle,chunk)=>{if(chunk.map){bundleMap.sections.push({offset:{line:bundle.split("\n").length-1,column:0},map:chunk.map})}return`${bundle.trim()}\n${chunk.code}`},"");if(styles){assetBundle+="!(function(){"+"var __a,__s,__f=function(){"+"if(__a){return;}"+"__a=1;"+"__s=document.createElement('style');__s.dataset.id='"+TEST_ID+"',__s.innerHTML='"+styles.replace(/([\r\n\s]+)/g," ").replace(/'/g,"\\'")+"';"+"document.head.appendChild(__s);"+"};"+(testConfig.appendStyles?"__f();":"window._addStyles=__f;")+"})();"}if(assetBundle&&fnIifeCheck.test(assetBundle)&&outputOptions.format==="iife"){assetBundle="!"+assetBundle}if(watch){assetBundle+="\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,"+Buffer.from(JSON.stringify(bundleMap)).toString("base64");if(testConfig.debug){_fs.default.writeFile(_path.default.resolve(buildDir,"bundle.js.map"),JSON.stringify(bundleMap),err=>{if(!err){console.log("Wrote bundle.js.map to build folder.")}else{console.error(err)}})}}_fs.default.writeFile(_path.default.resolve(buildDir,getFileAs(mainChunk.fileName,"bundle.js")),assetBundle,err=>{if(err){console.error(err)}else if(!TEST_ENV&&!watch){const mainChunk=bundleOutput.output[0];const bundleName=getFileAs(mainChunk.fileName,"bundle.js");const bundleSize=toKb(assetBundle);const len=bundleOutput.output.reduce((acc,cur)=>Math.max(acc,cur.fileName.length),bundleName.length)+3;const fullLen=len+bundleSize.length;console.log(_chalk.default.cyan("Output size:"));console.log(_chalk.default.cyan("-".repeat(fullLen)));bundleOutput.output.forEach((output,index)=>{let code=output.code||output.source||"";if(!index&&amd){code=`!(function(){${amd.code}\n${code}})();`}const line=output.fileName.padEnd(len)+toKb(code).padStart(bundleSize.length)||"";console.log(_chalk.default.cyan(line))});console.log(_chalk.default.cyan(bundleName.padEnd(len)+bundleSize));console.log(_chalk.default.cyan("-".repeat(fullLen)));console.log()}});return{bundle:assetBundle,styles:!!styles,js:!!js}};let assetBundle;let watcher;if(!watch){clearHashedAssets();try{bundle=await(0,_rollup.rollup)(inputOptions);bundleOutput=await bundle.write(outputOptions)}catch(error){console.log(_chalk.default.red("\nBundle error!"));throw new Error(error.message)}await createAssetBundle(buildDir,entryPart);await bundle.close()}else{const watcherConfig={...inputOptions,output:outputOptions,watch:{buildDelay:300,exclude:[_path.default.join(testConfig.buildDir,"**")]}};if(testConfig.debug){console.log("Starting watcher, with config");console.log(watcherConfig)}watcher=(0,_rollup.watch)(watcherConfig);let page;let hasError=false;watcher.on("event",async event=>{if(event.code==="ERROR"){console.log(_chalk.default.red("\nBundle error!"));console.error(event.error.message,"\n");hasError=true;if(page){await page.evaluate(msg=>{console.log("\n\x1B[31m%s\x1B[0m","Bundle error!");console.warn(msg,"\n")},event.error.message)}}else if(event.code==="BUNDLE_START"){if(page){console.log(_chalk.default.cyan("Source code changed."));await page.evaluate(()=>{console.log("\x1B[92m%s\x1B[0m","Source code changed. Starting bundler...")})}console.log(_chalk.default.cyan("Starting bundler..."));clearHashedAssets();hasError=false}else if(event.code==="BUNDLE_END"){if(hasError){return}bundleOutput=await event.result.generate(outputOptions);assetBundle=await createAssetBundle(buildDir,entryPart);page=await(0,_puppeteer.openPage)({...testConfig,assetBundle},true);hasError=false;await event.result.close()}})}return{...testConfig,assetBundle,watcher}}function toKb(str=""){return Math.round(str.length/1024*10)/10+" kB"}function getFileAs(entryPart,ext){const entryPathArrWithoutExt=entryPart.split(".").slice(0,-1);return entryPathArrWithoutExt.concat(ext).join(".")}function getPluginsConfig(defaults,override=[]){const fns={alias:_pluginAlias.default,"node-resolve":_pluginNodeResolve.default,babel:_pluginBabel.default,styles:_rollupPluginStyles.default,replace:_pluginReplace.default,commonjs:_pluginCommonjs.default,iife:_rollupPluginIife.default,"inline-svg":_rollupPluginInlineSvg.default,"svg-hyperscript":_rollupPluginSvgHyperscript.default,image:_pluginImage.default,"preact-debug":_preactDebugPlugin.preactDebug,typescript:_rollupPluginTypescript.default};return defaults.map(plugin=>{if(!Array.isArray(plugin))return plugin;const[key,options]=plugin;const fn=fns[key];const overridePlugin=override.find(op=>{if(!Array.isArray(op))return false;return op[0]===key});if(overridePlugin){override.splice(override.indexOf(overridePlugin),1);if(typeof overridePlugin[1]==="function"){return fn(overridePlugin[1](options))}else{return fn(overridePlugin[1])}}return fn(options)}).concat(override.map(plugin=>{let fn=plugin;if(Array.isArray(fn)){if(typeof fn[1]==="function"){return fn[1]()}else{console.error(_chalk.default.red(`There's no default plugin for ${_chalk.default.bold(fn[0])}. Can't call default plugin with given argument `,fn[1]));console.error(_chalk.default.red(`Custom plugins should be inserted as objects or as a [string, function] tuple, got`),fn)}}if(typeof fn==="function"){return fn()}return fn}))}